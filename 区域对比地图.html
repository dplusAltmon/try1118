<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>区域文化产业热力地图</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/topojson@3.0.2/dist/topojson.min.js"></script>
    <style>
        body { margin: 0; }
        #map { width: 100%; height: 800px; }
        .tooltip {
            position: absolute;
            background: rgba(255,255,255,0.9);
            padding: 10px;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none;
        }
        .heatmap-legend {
            position: absolute;
            right: 20px;
            top: 20px;
            background: white;
            padding: 10px;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin: 5px 0;
        }
        .legend-color {
            width: 20px;
            height: 20px;
            margin-right: 8px;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div class="tooltip" id="tooltip"></div>
    <div class="heatmap-legend" id="legend"></div>

    <script>
        // 区域数据（与用户提供的regionData一致）
        const regionData = [
            { name: "东部地区", revenue: 112800, growth: 7.5 },
            { name: "中部地区", revenue: 38600, growth: 8.2 },
            { name: "西部地区", revenue: 28500, growth: 8.8 },
            { name: "东北地区", revenue: 8100, growth: 6.5 }
        ];

        // 省份到地区的映射
        const provinceMap = {
            '北京': '东部', '天津': '东部', '河北': '东部', '上海': '东部',
            '江苏': '东部', '浙江': '东部', '福建': '东部', '山东': '东部',
            '广东': '东部', '海南': '东部', '山西': '中部', '安徽': '中部',
            '江西': '中部', '河南': '中部', '湖北': '中部', '湖南': '中部',
            '内蒙古': '西部', '广西': '西部', '重庆': '西部', '四川': '西部',
            '贵州': '西部', '云南': '西部', '西藏': '西部', '陕西': '西部',
            '甘肃': '西部', '青海': '西部', '宁夏': '西部', '新疆': '西部',
            '辽宁': '东北', '吉林': '东北', '黑龙江': '东北'
        };

        // 加载地理数据（需替换为实际路径）
        d3.json("https://geojson.cn/api/china/1.6.2/china.topo.json").then(topology => {
            const provinces = topojson.feature(topology, topology.objects.provinces).features;

            // 预处理省份名称（去除自治区后缀）
            provinces.forEach(province => {
                const name = province.properties.name.replace(/自治区|省|市/g, '');
                province.properties.name = name;
            });

            // 创建热力图颜色比例尺（根据营收）
            const revenueScale = d3.scaleSequential()
                .interpolator(d3.interpolateReds)
                .domain([0, d3.max(regionData, d => d.revenue)]);

            // 创建地图投影
            const projection = d3.geoMercator()
                .center([107, 31])
                .scale(860)
                .translate([window.innerWidth/2, window.innerHeight/2]);

            // 创建路径生成器
            const path = d3.geoPath().projection(projection);

            // 绘制地图
            const svg = d3.select("#map").append("svg")
                .attr("width", "100%")
                .attr("height", "100%");

            svg.selectAll("path")
                .data(provinces)
                .enter()
                .append("path")
                .attr("d", path)
                .attr("fill", d => {
                    const regionName = provinceMap[d.properties.name];
                    if (regionName) {
                        const region = regionData.find(r => r.name === `${regionName}地区`);
                        return revenueScale(region.revenue);
                    }
                    return "#e0e0e0"; // 默认颜色
                })
                .on("mouseover", function(d) {
                    const regionName = provinceMap[d.properties.name];
                    if (regionName) {
                        const region = regionData.find(r => r.name === `${regionName}地区`);
                        const tooltip = d3.select("#tooltip");
                        tooltip.html(`
                            <h3>${regionName}地区</h3>
                            <p>营业收入：${region.revenue.toLocaleString()}亿元</p>
                            <p>增长率：${region.growth}%</p>
                        `)
                        .style("opacity", 1)
                        .style("left", `${d3.event.pageX + 10}px`)
                        .style("top", `${d3.event.pageY - 20}px`);
                    }
                })
                .on("mouseout", () => {
                    d3.select("#tooltip").style("opacity", 0);
                });

            // 创建热力图图例
            const legend = d3.select("#legend");
            revenueScale.quantiles(4).forEach((value, i) => {
                const color = revenueScale(value);
                legend.append("div")
                    .classed("legend-item", true)
                    .html(`
                        <div class="legend-color" style="background: ${color}"></div>
                        <span>${value.toLocaleString()}亿元以上</span>
                    `);
            });
        });

        // 窗口resize适配
        window.addEventListener("resize", () => {
            const svg = d3.select("#map svg");
            svg.attr("width", window.innerWidth)
               .attr("height", window.innerHeight);
            // 重新计算投影
            const projection = d3.geoMercator()
                .center([107, 31])
                .scale(860)
                .translate([window.innerWidth/2, window.innerHeight/2]);
            svg.selectAll("path").attr("d", d3.geoPath().projection(projection));
        });
    </script>
</body>
</html>
