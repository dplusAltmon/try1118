<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D3.js 层次数据可视化</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #2a4d69, #4b86b4);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            padding: 30px 0;
            margin-bottom: 20px;
        }
        
        h1 {
            font-size: 3.2rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            background: linear-gradient(45deg, #ff7e5f, #feb47b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.6;
        }
        
        .tabs {
            display: flex;
            justify-content: center;
            margin: 30px 0;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .tab-btn {
            padding: 12px 25px;
            background: rgba(255, 255, 255, 0.15);
            border: none;
            border-radius: 30px;
            color: white;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            min-width: 200px;
        }
        
        .tab-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-3px);
        }
        
        .tab-btn.active {
            background: linear-gradient(45deg, #ff7e5f, #feb47b);
            box-shadow: 0 4px 15px rgba(255, 126, 95, 0.4);
        }
        
        .tab-content {
            display: none;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .chart-header {
            text-align: center;
            margin-bottom: 25px;
        }
        
        .chart-header h2 {
            font-size: 2.2rem;
            margin-bottom: 10px;
            color: #ffb347;
        }
        
        .chart-header p {
            font-size: 1.1rem;
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.6;
            opacity: 0.85;
        }
        
        .chart-container {
            height: 600px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 15px;
            padding: 15px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .chart-container svg {
            width: 100%;
            height: 100%;
        }
        
        .tooltip {
            position: absolute;
            padding: 12px 16px;
            background: rgba(0, 0, 0, 0.85);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            pointer-events: none;
            font-size: 14px;
            line-height: 1.5;
            max-width: 300px;
            z-index: 10;
            opacity: 0;
            transition: opacity 0.2s;
            color: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .tooltip h3 {
            margin: 0 0 8px 0;
            color: #ffb347;
            font-size: 16px;
        }
        
        .tooltip p {
            margin: 5px 0;
        }
        
        .legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }
        
        .data-section {
            margin-top: 40px;
            padding: 25px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
        }
        
        .data-section h3 {
            font-size: 1.8rem;
            margin-bottom: 20px;
            color: #ffb347;
            text-align: center;
        }
        
        .data-content {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .data-text {
            flex: 1;
            min-width: 300px;
            line-height: 1.8;
            font-size: 1.1rem;
        }
        
        .data-text p {
            margin-bottom: 15px;
        }
        
        .signature {
            text-align: right;
            margin-top: 20px;
            font-style: italic;
            opacity: 0.8;
        }
        
        footer {
            text-align: center;
            padding: 30px 0;
            margin-top: 40px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        @media (max-width: 768px) {
            .tabs {
                flex-direction: column;
                align-items: center;
            }
            
            .tab-btn {
                width: 100%;
                max-width: 300px;
            }
            
            .chart-container {
                height: 400px;
            }
            
            h1 {
                font-size: 2.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>D3.js 层次数据可视化</h1>
            <p class="subtitle">使用 flare.json 数据集展示三种层次数据可视化技术：矩形树图、圆形树图和旭日图</p>
        </header>
        
        <div class="tabs">
            <button class="tab-btn active" data-tab="treemap">矩形树图 (Treemap)</button>
            <button class="tab-btn" data-tab="pack">圆形树图 (Circle Packing)</button>
            <button class="tab-btn" data-tab="sunburst">旭日图 (Sunburst)</button>
        </div>
        
        <!-- 矩形树图 -->
        <div id="treemap-tab" class="tab-content active">
            <div class="chart-header">
                <h2>矩形树图 (Treemap)</h2>
                <p>矩形树图使用嵌套矩形展示层次结构，每个矩形的大小与其值成比例。颜色表示不同的类别。</p>
            </div>
            <div id="treemap-container" class="chart-container"></div>
        </div>
        
        <!-- 圆形树图 -->
        <div id="pack-tab" class="tab-content">
            <div class="chart-header">
                <h2>圆形树图 (Circle Packing)</h2>
                <p>圆形树图使用嵌套圆形展示层次结构，每个圆形的大小与其值成比例。颜色表示不同的层级深度。</p>
            </div>
            <div id="pack-container" class="chart-container"></div>
        </div>
        
        <!-- 旭日图 -->
        <div id="sunburst-tab" class="tab-content">
            <div class="chart-header">
                <h2>旭日图 (Sunburst)</h2>
                <p>旭日图使用放射状的分层结构展示层次数据，每个弧形的角度与其值成比例。颜色表示不同的类别。</p>
            </div>
            <div id="sunburst-container" class="chart-container"></div>
        </div>
        
        <div class="data-section">
            <h3>数据洞察与分析</h3>
            <div class="data-content">
                <div class="data-text">
                    <p><strong>数据集概述：</strong>flare.json 数据集是 D3.js 官方示例中常用的层次结构数据集，它展示了软件包和类的层次结构。该数据集包含多个层级的节点，每个节点都有名称和值属性。</p>
                    
                    <p><strong>可视化分析：</strong></p>
                    <p>1. 矩形树图清晰地展示了数据中各个部分的大小比例，适合比较不同类别的相对重要性。</p>
                    <p>2. 圆形树图通过嵌套圆形展示了层次关系，中心节点表示根节点，越往外层级越深。</p>
                    <p>3. 旭日图以放射状形式展示层次结构，角度大小表示节点值的大小，适合展示层级间的比例关系。</p>
                    
                    <p><strong>交互功能：</strong>所有可视化都支持鼠标悬停查看详细信息，点击节点可以聚焦查看子层级。使用左上角的控制按钮可以在不同可视化之间切换。</p>
                </div>
                
                <div class="data-text">
                    <p><strong>设计原则：</strong></p>
                    <p>1. <strong>Overview first</strong> - 首先提供整体概览，让用户快速理解数据结构</p>
                    <p>2. <strong>Zoom and filter</strong> - 支持缩放和筛选功能，深入查看细节</p>
                    <p>3. <strong>Details on demand</strong> - 通过悬停工具提示提供详细信息</p>
                    
                    <p><strong>色彩方案：</strong>使用 D3 的 interpolateRainbow 色标，为不同层级和类别分配独特且易于区分的颜色。</p>
                    
                    <p><strong>技术实现：</strong>使用 D3.js v7 实现层次数据可视化，包括 d3.treemap(), d3.pack() 和 d3.partition() 布局算法。</p>
                    
                    <div class="signature">
                        <p>数据可视化分析报告</p>
                        <p>制作日期: 2023年11月</p>
                    </div>
                </div>
            </div>
        </div>
        
        <footer>
            <p>D3.js 层次数据可视化展示 | 使用 flare.json 数据集 | 基于 Ben Shneiderman 的可视化原则</p>
        </footer>
    </div>
    
    <div id="tooltip" class="tooltip"></div>
    
    <script>
        // 标签切换功能
        document.querySelectorAll('.tab-btn').forEach(button => {
            button.addEventListener('click', () => {
                // 移除所有活动状态
                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                
                // 添加当前活动状态
                button.classList.add('active');
                const tabId = button.getAttribute('data-tab');
                document.getElementById(`${tabId}-tab`).classList.add('active');
            });
        });
        
        // 工具提示
        const tooltip = d3.select("#tooltip");
        
        // 加载数据并创建可视化
        d3.json("flare.json").then(data => {
            // 创建层次结构
            const root = d3.hierarchy(data);
            root.sum(d => d.value ? d.value : 0);
            
            // 创建颜色比例尺
            const color = d3.scaleSequential(d3.interpolateRainbow)
                .domain([0, root.height]);
            
            // 1. 绘制矩形树图
            createTreemap(root, color);
            
            // 2. 绘制圆形树图
            createCirclePacking(root, color);
            
            // 3. 绘制旭日图
            createSunburst(root, color);
        }).catch(error => {
            console.error("加载数据时出错:", error);
            d3.select("#treemap-container").html("<p class='error'>无法加载数据，请检查flare.json文件是否存在</p>");
        });
        
        // 创建矩形树图
        function createTreemap(root, color) {
            const width = document.getElementById('treemap-container').clientWidth;
            const height = document.getElementById('treemap-container').clientHeight;
            
            // 移除旧的SVG
            d3.select("#treemap-container").selectAll("svg").remove();
            
            // 创建SVG容器
            const svg = d3.select("#treemap-container")
                .append("svg")
                .attr("width", width)
                .attr("height", height);
            
            // 创建树图布局
            const treemap = d3.treemap()
                .size([width, height])
                .padding(1)
                .round(true);
            
            // 计算布局
            treemap(root);
            
            // 创建单元格
            const cell = svg.selectAll("g")
                .data(root.descendants())
                .join("g")
                .attr("transform", d => `translate(${d.x0},${d.y0})`);
            
            // 添加矩形
            cell.append("rect")
                .attr("width", d => d.x1 - d.x0)
                .attr("height", d => d.y1 - d.y0)
                .attr("fill", d => color(d.depth))
                .attr("stroke", "#fff")
                .attr("stroke-width", 1)
                .on("mouseover", function(event, d) {
                    tooltip
                        .html(`<h3>${d.data.name}</h3>
                               <p>值: ${d.value}</p>
                               <p>深度: ${d.depth}</p>
                               <p>子节点数: ${d.children ? d.children.length : 0}</p>`)
                        .style("opacity", 1)
                        .style("left", (event.pageX + 15) + "px")
                        .style("top", (event.pageY - 15) + "px");
                    
                    d3.select(this)
                        .attr("stroke", "#000")
                        .attr("stroke-width", 2);
                })
                .on("mouseout", function() {
                    tooltip.style("opacity", 0);
                    d3.select(this)
                        .attr("stroke", "#fff")
                        .attr("stroke-width", 1);
                });
            
            // 添加文本标签
            cell.filter(d => (d.x1 - d.x0) > 40 && (d.y1 - d.y0) > 20)
                .append("text")
                .attr("x", 5)
                .attr("y", 15)
                .attr("font-size", 10)
                .text(d => d.data.name)
                .attr("fill", "#fff")
                .attr("pointer-events", "none");
        }
        
        // 创建圆形树图
        function createCirclePacking(root, color) {
            const width = document.getElementById('pack-container').clientWidth;
            const height = document.getElementById('pack-container').clientHeight;
            const radius = Math.min(width, height) / 2;
            
            // 移除旧的SVG
            d3.select("#pack-container").selectAll("svg").remove();
            
            // 创建SVG容器
            const svg = d3.select("#pack-container")
                .append("svg")
                .attr("width", width)
                .attr("height", height)
                .append("g")
                .attr("transform", `translate(${width/2},${height/2})`);
            
            // 创建圆形布局
            const pack = d3.pack()
                .size([width - 2, height - 2])
                .padding(3);
            
            // 计算布局
            pack(root);
            
            // 添加圆形
            const node = svg.selectAll("circle")
                .data(root.descendants())
                .join("circle")
                .attr("cx", d => d.x)
                .attr("cy", d => d.y)
                .attr("r", d => d.r)
                .attr("fill", d => color(d.depth))
                .attr("stroke", "#fff")
                .attr("stroke-width", 1)
                .on("mouseover", function(event, d) {
                    tooltip
                        .html(`<h3>${d.data.name}</h3>
                               <p>值: ${d.value}</p>
                               <p>深度: ${d.depth}</p>
                               <p>半径: ${d.r.toFixed(1)}</p>`)
                        .style("opacity", 1)
                        .style("left", (event.pageX + 15) + "px")
                        .style("top", (event.pageY - 15) + "px");
                    
                    d3.select(this)
                        .attr("stroke", "#000")
                        .attr("stroke-width", 2);
                })
                .on("mouseout", function() {
                    tooltip.style("opacity", 0);
                    d3.select(this)
                        .attr("stroke", "#fff")
                        .attr("stroke-width", 1);
                });
            
            // 添加文本标签
            svg.selectAll("text")
                .data(root.descendants().filter(d => d.r > 20))
                .join("text")
                .attr("x", d => d.x)
                .attr("y", d => d.y)
                .attr("text-anchor", "middle")
                .attr("dy", "0.35em")
                .attr("font-size", d => Math.min(2 * d.r, (2 * d.r - 8) / this.getComputedTextLength() * 12))
                .text(d => d.data.name)
                .attr("fill", "#fff")
                .attr("pointer-events", "none");
        }
        
        // 创建旭日图
        function createSunburst(root, color) {
            const width = document.getElementById('sunburst-container').clientWidth;
            const height = document.getElementById('sunburst-container').clientHeight;
            const radius = Math.min(width, height) / 2;
            
            // 移除旧的SVG
            d3.select("#sunburst-container").selectAll("svg").remove();
            
            // 创建SVG容器
            const svg = d3.select("#sunburst-container")
                .append("svg")
                .attr("width", width)
                .attr("height", height)
                .append("g")
                .attr("transform", `translate(${width/2},${height/2})`);
            
            // 创建分区布局
            const partition = d3.partition()
                .size([2 * Math.PI, radius]);
            
            // 计算布局
            partition(root);
            
            // 创建弧生成器
            const arc = d3.arc()
                .startAngle(d => d.x0)
                .endAngle(d => d.x1)
                .innerRadius(d => d.y0)
                .outerRadius(d => d.y1);
            
            // 添加路径
            const path = svg.selectAll("path")
                .data(root.descendants())
                .join("path")
                .attr("d", arc)
                .attr("fill", d => color(d.depth))
                .attr("stroke", "#fff")
                .attr("stroke-width", 1)
                .on("mouseover", function(event, d) {
                    tooltip
                        .html(`<h3>${d.data.name}</h3>
                               <p>值: ${d.value}</p>
                               <p>深度: ${d.depth}</p>
                               <p>角度: ${((d.x1 - d.x0) * 180 / Math.PI).toFixed(1)}°</p>`)
                        .style("opacity", 1)
                        .style("left", (event.pageX + 15) + "px")
                        .style("top", (event.pageY - 15) + "px");
                    
                    d3.select(this)
                        .attr("stroke", "#000")
                        .attr("stroke-width", 2);
                })
                .on("mouseout", function() {
                    tooltip.style("opacity", 0);
                    d3.select(this)
                        .attr("stroke", "#fff")
                        .attr("stroke-width", 1);
                });
            
            // 添加文本标签
            svg.selectAll("text")
                .data(root.descendants().filter(d => (d.x1 - d.x0) > 0.05 && d.y0 > 20))
                .join("text")
                .attr("transform", function(d) {
                    const x = (d.x0 + d.x1) / 2 * 180 / Math.PI;
                    const y = (d.y0 + d.y1) / 2;
                    return `rotate(${x - 90}) translate(${y},0) rotate(${x < 180 ? 0 : 180})`;
                })
                .attr("text-anchor", "middle")
                .attr("dy", "0.35em")
                .attr("font-size", d => Math.min(12, (d.x1 - d.x0) * radius / 8))
                .text(d => d.data.name)
                .attr("fill", "#fff")
                .attr("pointer-events", "none");
        }
    </script>
</body>
</html>
