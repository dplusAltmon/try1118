<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>层次数据多视图可视化</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Helvetica Neue", Arial, sans-serif;
        }

        body {
            background-color: #f9f9f9;
            color: #333;
            padding: 20px;
        }

        /* 标题区域样式 */
        .title-container {
            text-align: center;
            margin: 30px 0 40px;
        }

        .main-title {
            font-size: 36px;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 10px;
            letter-spacing: -0.5px;
        }

        .sub-title {
            font-size: 18px;
            color: #7f8c8d;
            font-weight: 400;
        }

        /* 图表容器布局 */
        .charts-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 30px;
            margin-bottom: 50px;
        }

        .chart-wrapper {
            width: 550px;
            height: 550px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            padding: 20px;
            position: relative;
        }

        .chart-title {
            font-size: 18px;
            color: #2c3e50;
            margin-bottom: 15px;
            text-align: center;
            font-weight: 600;
        }

        /* 树图样式 */
        .treemap-cell {
            stroke: white;
            stroke-width: 2px;
            cursor: pointer;
            transition: opacity 0.3s;
        }

        .treemap-cell:hover {
            opacity: 0.8;
        }

        .treemap-label {
            font-size: 12px;
            fill: white;
            pointer-events: none;
            text-anchor: middle;
            dominant-baseline: middle;
            text-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }

        /* 泡泡树样式 */
        .pack-circle {
            stroke: white;
            stroke-width: 2px;
            cursor: pointer;
            transition: stroke-width 0.3s;
        }

        .pack-circle:hover {
            stroke-width: 4px;
        }

        .pack-label {
            font-size: 10px;
            fill: #333;
            pointer-events: none;
            text-anchor: middle;
        }

        /* 太阳图样式 */
        .sunburst-arc {
            cursor: pointer;
            transition: opacity 0.3s;
        }

        .sunburst-arc:hover {
            opacity: 0.8;
        }

        .sunburst-label {
            font-size: 11px;
            fill: white;
            pointer-events: none;
            text-anchor: middle;
            dominant-baseline: middle;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }

        /* 提示框样式 */
        .tooltip {
            position: absolute;
            padding: 12px 15px;
            background: rgba(0,0,0,0.8);
            color: white;
            border-radius: 6px;
            font-size: 14px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 100;
            max-width: 200px;
        }

        /* 数据说明区域 */
        .data-essay {
            max-width: 1150px;
            margin: 0 auto 40px;
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }

        .essay-title {
            font-size: 20px;
            color: #2c3e50;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .essay-content {
            font-size: 15px;
            line-height: 1.7;
            color: #555;
        }

        /* 签名档样式 */
        .signature {
            text-align: center;
            padding: 20px;
            border-top: 1px dashed #ddd;
            max-width: 1150px;
            margin: 0 auto;
            color: #7f8c8d;
        }

        .signature-title {
            font-size: 16px;
            margin-bottom: 5px;
            color: #2c3e50;
        }
    </style>
</head>
<body>
    <!-- 标题区域 -->
    <div class="title-container">
        <h1 class="main-title">层次数据可视化多视图对比</h1>
        <p class="sub-title">基于flare.json的面积树图、泡泡树与太阳图展示 | 遵循"概览优先，按需缩放与详情"原则</p>
    </div>

    <!-- 图表容器 -->
    <div class="charts-container">
        <!-- 面积树图 -->
        <div class="chart-wrapper">
            <h3 class="chart-title">1. 面积树图 (Treemap)</h3>
            <div class="tooltip" id="treemap-tooltip"></div>
            <svg id="treemap" width="510" height="500"></svg>
        </div>

        <!-- 泡泡树 -->
        <div class="chart-wrapper">
            <h3 class="chart-title">2. 泡泡树 (Circle Packing)</h3>
            <div class="tooltip" id="pack-tooltip"></div>
            <svg id="pack" width="510" height="500"></svg>
        </div>

        <!-- 太阳图 -->
        <div class="chart-wrapper">
            <h3 class="chart-title">3. 太阳图 (Sunburst)</h3>
            <div class="tooltip" id="sunburst-tooltip"></div>
            <svg id="sunburst" width="510" height="500"></svg>
        </div>
    </div>

    <!-- 数据小作文 -->
    <div class="data-essay">
        <h3 class="essay-title">数据洞察与可视化说明</h3>
        <div class="essay-content">
            本次可视化采用flare.json层次数据（模拟软件包结构与大小关系），通过三种视图展示同一数据的不同维度特征。面积树图以矩形面积直观反映节点权重，适合比较同级数据大小；泡泡树通过嵌套圆圈展示层次嵌套关系，便于识别整体结构；太阳图以径向布局呈现多层级占比，突出中心节点与外围的从属关系。<br><br>
            核心发现：数据中"flare.vis"和"flare.data"分支权重最大，反映可视化与数据处理模块的重要性；叶子节点"flare.vis.interaction"和"flare.data.util"数值突出，说明交互组件与工具类在系统中的基础作用。<br><br>
            设计遵循"概览优先"原则：先通过整体布局把握数据结构，再通过鼠标悬停查看详情（如节点名称、数值、层级），实现按需获取信息。色彩采用d3.schemeCategory10分类色系，确保同层级节点区分度，提升层次感知。
        </div>
    </div>

    <!-- 签名档 -->
    <div class="signature">
        <div class="signature-title">数据可视化作业 | 层次数据多视图展示</div>
        <div>数据来源：flare.json（模拟软件包层次结构数据） | 技术：D3.js v7</div>
        <div>设计原则：概览优先，按需缩放与详情 | 作者：[你的姓名]</div>
    </div>

    <script>
        // 加载flare.json数据
        d3.json("flare.json").then(data => {
            // 数据处理：转换为层次结构
            const root = d3.hierarchy(data)
                .sum(d => d.value) // 以value为权重
                .sort((a, b) => b.value - a.value);

            // 共用配色方案
            const color = d3.scaleOrdinal(d3.schemeCategory10);

            // 1. 绘制面积树图 (Treemap)
            const treemapLayout = d3.treemap()
                .size([510, 500])
                .padding(2);

            treemapLayout(root);

            const treemapSvg = d3.select("#treemap");

            // 绘制单元格
            const treemapCells = treemapSvg.selectAll("rect")
                .data(root.leaves())
                .enter()
                .append("rect")
                .attr("class", "treemap-cell")
                .attr("x", d => d.x0)
                .attr("y", d => d.y0)
                .attr("width", d => d.x1 - d.x0)
                .attr("height", d => d.y1 - d.y0)
                .attr("fill", d => {
                    while (d.depth > 1) d = d.parent;
                    return color(d.data.name);
                })
                .on("mouseover", (e, d) => {
                    // 显示详情
                    d3.select("#treemap-tooltip")
                        .html(`<strong>${d.data.name}</strong><br>
                               数值: ${d.value}<br>
                               层级: ${d.depth}<br>
                               父节点: ${d.parent.data.name}`)
                        .style("opacity", 1)
                        .style("left", (e.pageX + 10) + "px")
                        .style("top", (e.pageY - 20) + "px");
                })
                .on("mouseout", () => {
                    d3.select("#treemap-tooltip").style("opacity", 0);
                });

            // 添加标签（仅显示较大单元格）
            treemapSvg.selectAll("text")
                .data(root.leaves())
                .enter()
                .append("text")
                .attr("class", "treemap-label")
                .attr("x", d => (d.x0 + d.x1) / 2)
                .attr("y", d => (d.y0 + d.y1) / 2)
                .text(d => (d.x1 - d.x0 > 40 && d.y1 - d.y0 > 20) ? d.data.name : "") // 仅显示足够大的标签
                .attr("font-size", d => Math.min(d.x1 - d.x0, d.y1 - d.y0) / 5);

            // 2. 绘制泡泡树 (Circle Packing)
            const packLayout = d3.pack()
                .size([510, 500])
                .padding(3);

            packLayout(root);

            const packSvg = d3.select("#pack")
                .append("g")
                .attr("transform", "translate(0, 0)");

            // 绘制圆圈
            const packCircles = packSvg.selectAll("circle")
                .data(root.descendants())
                .enter()
                .append("circle")
                .attr("class", "pack-circle")
                .attr("cx", d => d.x)
                .attr("cy", d => d.y)
                .attr("r", d => d.r)
                .attr("fill", d => {
                    while (d.depth > 1) d = d.parent;
                    return color(d.data.name);
                })
                .on("mouseover", (e, d) => {
                    d3.select("#pack-tooltip")
                        .html(`<strong>${d.data.name}</strong><br>
                               数值: ${d.value || "N/A"}<br>
                               层级: ${d.depth}<br>
                               半径: ${d.r.toFixed(1)}`)
                        .style("opacity", 1)
                        .style("left", (e.pageX + 10) + "px")
                        .style("top", (e.pageY - 20) + "px");
                })
                .on("mouseout", () => {
                    d3.select("#pack-tooltip").style("opacity", 0);
                });

            // 添加标签
            packSvg.selectAll("text")
                .data(root.descendants())
                .enter()
                .append("text")
                .attr("class", "pack-label")
                .attr("x", d => d.x)
                .attr("y", d => d.y)
                .text(d => (d.r > 15) ? d.data.name : "") // 仅显示足够大的标签
                .attr("dy", ".3em")
                .attr("font-size", d => Math.min(2 * d.r, (2 * d.r - 8) / this.getComputedTextLength() * 16));

            // 3. 绘制太阳图 (Sunburst)
            const sunburstLayout = d3.partition()
                .size([2 * Math.PI, 250]); // 半径250

            sunburstLayout(root);

            const sunburstSvg = d3.select("#sunburst")
                .append("g")
                .attr("transform", "translate(255, 250)"); // 居中

            // 绘制圆弧
            const sunburstArcs = sunburstSvg.selectAll("path")
                .data(root.descendants())
                .enter()
                .append("path")
                .attr("class", "sunburst-arc")
                .attr("d", d3.arc()
                    .startAngle(d => d.x0)
                    .endAngle(d => d.x1)
                    .innerRadius(d => Math.max(0, d.y0))
                    .outerRadius(d => Math.max(0, d.y1))
                )
                .attr("fill", d => {
                    while (d.depth > 1) d = d.parent;
                    return color(d.data.name);
                })
                .on("mouseover", (e, d) => {
                    d3.select("#sunburst-tooltip")
                        .html(`<strong>${d.data.name}</strong><br>
                               数值: ${d.value || "N/A"}<br>
                               层级: ${d.depth}<br>
                               角度范围: ${(d.x0 * 180 / Math.PI).toFixed(1)}° - ${(d.x1 * 180 / Math.PI).toFixed(1)}°`)
                        .style("opacity", 1)
                        .style("left", (e.pageX + 10) + "px")
                        .style("top", (e.pageY - 20) + "px");
                })
                .on("mouseout", () => {
                    d3.select("#sunburst-tooltip").style("opacity", 0);
                });

            // 添加标签
            sunburstSvg.selectAll("text")
                .data(root.descendants().filter(d => d.depth && (d.x1 - d.x0) * d.y1 > 10))
                .enter()
                .append("text")
                .attr("class", "sunburst-label")
                .attr("transform", d => {
                    const x = (d.x0 + d.x1) / 2 * 180 / Math.PI;
                    const rotate = x < 90 || x > 270 ? x : x + 180;
                    return `rotate(${rotate}) translate(${d.y1 + 5},0) rotate(${x < 90 || x > 270 ? 0 : 180})`;
                })
                .attr("dy", "0.35em")
                .text(d => d.data.name);

        }).catch(error => {
            console.error("数据加载失败:", error);
            document.querySelector(".charts-container").innerHTML = `<div style="color: red; padding: 20px;">无法加载flare.json，请确保文件在同一目录下</div>`;
        });
    </script>
</body>
</html>
