<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>区域对比</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/examples/js/controls/OrbitControls.js"></script>
    <style>
        .container { width: 1200px; margin: 0 auto; padding: 20px; }
        .section-title { color: #1a365d; font-size: 24px; border-bottom: 2px solid #e2e8f0; padding-bottom: 10px; }
        .viz-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .viz-card { background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); padding: 15px; }
        .full-width { grid-column: 1 / -1; }
        .viz-title { font-size: 18px; color: #333; margin-bottom: 15px; }
        .tooltip { position: absolute; background: white; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; opacity: 0; pointer-events: none; }
    </style>
</head>
<body>
    <div class="container">
        <h2 class="section-title">区域对比</h2>
        <div class="viz-grid">
            <!-- 1. 三维行业×区域营收对比图 -->
            <div class="viz-card full-width">
                <div class="viz-title">三维行业×区域营收分布（亿元）</div>
                <div id="3d-region" style="width: 100%; height: 400px;"></div>
            </div>
            <!-- 2. 区域营收柱状图 -->
            <div class="viz-card">
                <div class="viz-title">四大区域总营收对比（亿元）</div>
                <div id="region-revenue" style="width: 100%; height: 300px;"></div>
            </div>
            <!-- 3. 人均文化消费对比 -->
            <div class="viz-card">
                <div class="viz-title">区域人均文化消费（元）</div>
                <div id="per-capita" style="width: 100%; height: 300px;"></div>
            </div>
        </div>
    </div>
    <div class="tooltip" id="tooltip"></div>

    <script>
        // 数据来源：国家统计局2024年文化产业区域数据
        const regionData = [
            { 
                name: "东部地区", 
                revenue: 112800, 
                growth: 7.5, 
                perCapita: 3200, 
                industries: [
                    { name: "内容创作", revenue: 35000 },
                    { name: "创意设计", revenue: 28000 },
                    { name: "文化传播", revenue: 22000 },
                    { name: "文化投资", revenue: 12000 },
                    { name: "其他", revenue: 15800 }
                ]
            },
            { 
                name: "中部地区", 
                revenue: 38600, 
                growth: 8.2, 
                perCapita: 2100, 
                industries: [
                    { name: "内容创作", revenue: 12000 },
                    { name: "创意设计", revenue: 7500 },
                    { name: "文化传播", revenue: 6800 },
                    { name: "文化投资", revenue: 3500 },
                    { name: "其他", revenue: 8800 }
                ]
            },
            { 
                name: "西部地区", 
                revenue: 28500, 
                growth: 8.8, 
                perCapita: 1900, 
                industries: [
                    { name: "内容创作", revenue: 9500 },
                    { name: "创意设计", revenue: 5800 },
                    { name: "文化传播", revenue: 5200 },
                    { name: "文化投资", revenue: 2200 },
                    { name: "其他", revenue: 5800 }
                ]
            },
            { 
                name: "东北地区", 
                revenue: 8100, 
                growth: 6.5, 
                perCapita: 2300, 
                industries: [
                    { name: "内容创作", revenue: 1500 },
                    { name: "创意设计", revenue: 1200 },
                    { name: "文化传播", revenue: 1800 },
                    { name: "文化投资", revenue: 800 },
                    { name: "其他", revenue: 2800 }
                ]
            }
        ];

        // 区域颜色比例尺
        const regionColor = d3.scaleOrdinal()
            .domain(regionData.map(d => d.name))
            .range(["#3182ce", "#48bb78", "#f6ad55", "#fc8181"]);

        // 1. Three.js三维行业×区域营收对比图
        function draw3DRegionChart() {
            const container = document.getElementById("3d-region");
            const width = container.clientWidth;
            const height = container.clientHeight;

            // 创建场景
            const scene = new THREE.Scene();
            scene.background = new THREE.Color(0xffffff);

            // 相机
            const camera = new THREE.PerspectiveCamera(60, width / height, 0.1, 1000);
            camera.position.set(40, 30, 60);

            // 渲染器
            const renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(width, height);
            container.appendChild(renderer.domElement);

            // 控制器（允许旋转、缩放）
            const controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;

            // 光源
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(ambientLight);
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(20, 40, 30);
            scene.add(directionalLight);

            // 数据参数
            const regions = regionData.map(d => d.name);
            const industries = regionData[0].industries.map(d => d.name);
            const xCount = industries.length; // X轴：行业
            const zCount = regions.length;   // Z轴：区域
            const gap = 4; // 间隔
            const baseSize = 3; // 基础尺寸

            // 地面网格
            const groundGeometry = new THREE.PlaneGeometry(
                xCount * (baseSize + gap) + gap, 
                zCount * (baseSize + gap) + gap
            );
            const groundMaterial = new THREE.MeshBasicMaterial({ color: 0xf7fafc, side: THREE.DoubleSide });
            const ground = new THREE.Mesh(groundGeometry, groundMaterial);
            ground.rotation.x = -Math.PI / 2;
            ground.position.y = -0.1;
            scene.add(ground);

            // 绘制三维柱状体（X=行业，Z=区域，Y=营收高度）
            regionData.forEach((region, zIndex) => {
                region.industries.forEach((industry, xIndex) => {
                    // 营收映射为高度（缩小1000倍便于显示）
                    const height = industry.revenue / 1000;
                    if (height <= 0) return;

                    // 几何体
                    const geometry = new THREE.BoxGeometry(baseSize, height, baseSize);
                    // 材质（区域颜色）
                    const color = new THREE.Color(regionColor(region.name));
                    color.multiplyScalar(0.9); // 稍暗
                    const material = new THREE.MeshLambertMaterial({ color: color });

                    // 位置计算
                    const xPos = -((xCount - 1) * (baseSize + gap)) / 2 + xIndex * (baseSize + gap);
                    const zPos = -((zCount - 1) * (baseSize + gap)) / 2 + zIndex * (baseSize + gap);
                    const yPos = height / 2; // 底部对齐到地面

                    const cube = new THREE.Mesh(geometry, material);
                    cube.position.set(xPos, yPos, zPos);
                    cube.userData = {
                        region: region.name,
                        industry: industry.name,
                        revenue: industry.revenue
                    };
                    scene.add(cube);

                    // 鼠标交互（射线检测）
                    const raycaster = new THREE.Raycaster();
                    const mouse = new THREE.Vector2();
                    container.addEventListener("mousemove", (e) => {
                        // 鼠标位置归一化
                        mouse.x = (e.clientX / width) * 2 - 1;
                        mouse.y = -(e.clientY / height) * 2 + 1;
                        // 射线检测
                        raycaster.setFromCamera(mouse, camera);
                        const intersects = raycaster.intersectObjects(scene.children);
                        if (intersects.length > 0 && intersects[0].object.userData.region) {
                            const data = intersects[0].object.userData;
                            d3.select("#tooltip")
                                .html(`<strong>${data.region} - ${data.industry}</strong><br>营收：${data.revenue.toLocaleString()}亿元`)
                                .style("opacity", 1)
                                .style("left", (e.pageX + 10) + "px")
                                .style("top", (e.pageY - 20) + "px");
                        } else {
                            d3.select("#tooltip").style("opacity", 0);
                        }
                    });
                });
            });

            // X轴（行业）标签
            industries.forEach((industry, i) => {
                addLabel(
                    industry, 
                    -((xCount - 1) * (baseSize + gap)) / 2 + i * (baseSize + gap), 
                    -1, 
                    -((zCount * (baseSize + gap)) / 2 + gap),
                    0, Math.PI / 2, 0 // 旋转角度
                );
            });

            // Z轴（区域）标签
            regions.forEach((region, i) => {
                addLabel(
                    region, 
                    -((xCount * (baseSize + gap)) / 2 + gap), 
                    -1, 
                    -((zCount - 1) * (baseSize + gap)) / 2 + i * (baseSize + gap),
                    0, 0, 0
                );
            });

            // Y轴（营收）标签
            addLabel("营收（千亿元）", 0, 30, 0, 0, 0, 0);

            // 标签添加函数
            function addLabel(text, x, y, z, rx, ry, rz) {
                // 创建Canvas文本纹理
                const canvas = document.createElement("canvas");
                const context = canvas.getContext("2d");
                canvas.width = 128;
                canvas.height = 32;
                context.font = "16px Arial";
                context.fillStyle = "#333";
                context.textAlign = "center";
                context.textBaseline = "middle";
                context.fillText(text, canvas.width / 2, canvas.height / 2);

                const texture = new THREE.CanvasTexture(canvas);
                const material = new THREE.MeshBasicMaterial({ map: texture, side: THREE.DoubleSide });
                const geometry = new THREE.PlaneGeometry(canvas.width / 16, canvas.height / 16);
                const mesh = new THREE.Mesh(geometry, material);
                mesh.position.set(x, y, z);
                mesh.rotation.set(rx, ry, rz);
                scene.add(mesh);
            }

            // 动画循环
            function animate() {
                requestAnimationFrame(animate);
                controls.update();
                renderer.render(scene, camera);
            }
            animate();

            // 窗口 resize 适配
            window.addEventListener("resize", () => {
                camera.aspect = container.clientWidth / container.clientHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(container.clientWidth, container.clientHeight);
            });
        }

        // 2. 区域营收柱状图
        function drawRegionRevenue() {
            const container = document.getElementById("region-revenue");
            const width = container.clientWidth;
            const height = container.clientHeight;
            const margin = { top: 20, right: 30, bottom: 50, left: 60 };
            const innerWidth = width - margin.left - margin.right;
            const innerHeight = height - margin.top - margin.bottom;

            const svg = d3.select("#region-revenue")
                .append("svg")
                .attr("width", width)
                .attr("height", height)
                .append("g")
                .attr("transform", `translate(${margin.left}, ${margin.top})`);

            // 比例尺
            const x = d3.scaleBand()
                .domain(regionData.map(d => d.name))
                .range([0, innerWidth])
                .padding(0.2);
            const y = d3.scaleLinear()
                .domain([0, d3.max(regionData, d => d.revenue) * 1.1])
                .range([innerHeight, 0]);

            // 坐标轴
            svg.append("g")
                .attr("transform", `translate(0, ${innerHeight})`)
                .call(d3.axisBottom(x))
                .selectAll("text")
                .attr("transform", "rotate(-15)")
                .attr("text-anchor", "end")
                .attr("dy", "0.5em");
            svg.append("g")
                .call(d3.axisLeft(y))
                .append("text")
                .attr("fill", "#333")
                .attr("transform", "rotate(-90)")
                .attr("y", -50)
                .attr("x", -innerHeight / 2)
                .attr("text-anchor", "middle")
                .text("总营收（亿元）");

            // 柱状图
            const bars = svg.selectAll(".region-bar")
                .data(regionData)
                .enter()
                .append("rect")
                .attr("class", "region-bar")
                .attr("x", d => x(d.name))
                .attr("y", d => y(d.revenue))
                .attr("width", x.bandwidth())
                .attr("height", d => innerHeight - y(d.revenue))
                .attr("fill", d => regionColor(d.name))
                .on("mouseover", (e, d) => {
                    d3.select("#tooltip")
                        .html(`<strong>${d.name}</strong><br>总营收：${d.revenue.toLocaleString()}亿元<br>增长率：${d.growth}%`)
                        .style("opacity", 1)
                        .style("left", (e.pageX + 10) + "px")
                        .style("top", (e.pageY - 20) + "px");
                })
                .on("mouseout", () => d3.select("#tooltip").style("opacity", 0));

            // 顶部标签（营收值）
            svg.selectAll(".revenue-label")
                .data(regionData)
                .enter()
                .append("text")
                .attr("class", "revenue-label")
                .attr("x", d => x(d.name) + x.bandwidth() / 2)
                .attr("y", d => y(d.revenue) - 10)
                .attr("text-anchor", "middle")
                .style("font-size", "12px")
                .text(d => (d.revenue / 10000).toFixed(1) + "万亿");
        }

        // 3. 区域人均文化消费对比
        function drawPerCapita() {
            const container = document.getElementById("per-capita");
            const width = container.clientWidth;
            const height = container.clientHeight;
            const margin = { top: 20, right: 30, bottom: 50, left: 60 };
            const innerWidth = width - margin.left - margin.right;
            const innerHeight = height - margin.top - margin.bottom;

            const svg = d3.select("#per-capita")
                .append("svg")
                .attr("width", width)
                .attr("height", height)
                .append("g")
                .attr("transform", `translate(${margin.left}, ${margin.top})`);

            // 排序（从高到低）
            const sortedData = [...regionData].sort((a, b) => b.perCapita - a.perCapita);

            // 比例尺
            const x = d3.scaleBand()
                .domain(sortedData.map(d => d.name))
                .range([0, innerWidth])
                .padding(0.2);
            const y = d3.scaleLinear()
                .domain([0, d3.max(sortedData, d => d.perCapita) * 1.1])
                .range([innerHeight, 0]);

            // 坐标轴
            svg.append("g")
                .attr("transform", `translate(0, ${innerHeight})`)
                .call(d3.axisBottom(x))
                .selectAll("text")
                .attr("transform", "rotate(-15)")
                .attr("text-anchor", "end")
                .attr("dy", "0.5em");
            svg.append("g")
                .call(d3.axisLeft(y))
                .append("text")
                .attr("fill", "#333")
                .attr("transform", "rotate(-90)")
                .attr("y", -50)
                .attr("x", -innerHeight / 2)
                .attr("text-anchor", "middle")
                .text("人均文化消费（元）");

            // 柱状图
            svg.selectAll(".per-capita-bar")
                .data(sortedData)
                .enter()
                .append("rect")
                .attr("class", "per-capita-bar")
                .attr("x", d => x(d.name))
                .attr("y", d => y(d.perCapita))
                .attr("width", x.bandwidth())
                .attr("height", d => innerHeight - y(d.perCapita))
                .attr("fill", d => regionColor(d.name))
                .on("mouseover", (e, d) => {
                    d3.select("#tooltip")
                        .html(`<strong>${d.name}</strong><br>人均文化消费：${d.perCapita}元`)
                        .style("opacity", 1)
                        .style("left", (e.pageX + 10) + "px")
                        .style("top", (e.pageY - 20) + "px");
                })
                .on("mouseout", () => d3.select("#tooltip").style("opacity", 0));
        }

        // 初始化图表
        draw3DRegionChart();
        drawRegionRevenue();
        drawPerCapita();
    </script>
</body>
</html>
