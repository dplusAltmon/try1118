<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŒºåŸŸæ–‡åŒ–äº§ä¸šæ•°æ®å¯¹æ¯”</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <!-- ä½¿ç”¨å…¼å®¹ç‰ˆæœ¬å¼•å…¥Three.js -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/OrbitControls.js"></script>
    <!-- å¼•å…¥CSS3DRenderer -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/renderers/CSS3DRenderer.js"></script>
    <style>
        :root {
            --primary: #1a365d;
            --secondary: #3182ce;
            --success: #48bb78;
            --warning: #f6ad55;
            --danger: #fc8181;
            --light: #f7fafc;
            --dark: #2d3748;
            --gray: #e2e8f0;
            --border-radius: 8px;
            --shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f0f4f8 0%, #e6f7ff 100%);
            color: #333;
            line-height: 1.6;
            padding-bottom: 40px;
        }
        
        .header {
            background: linear-gradient(to right, var(--primary), #2c5282);
            color: white;
            padding: 2rem 0;
            text-align: center;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }
        
        .header p {
            font-size: 1.1rem;
            max-width: 800px;
            margin: 0 auto;
            opacity: 0.9;
        }
        
        .container {
            width: 90%;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .section-title {
            color: var(--primary);
            font-size: 1.8rem;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--gray);
            margin-bottom: 1.5rem;
            position: relative;
            display: flex;
            align-items: center;
        }
        
        .section-title::after {
            content: "";
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 120px;
            height: 3px;
            background: var(--secondary);
        }
        
        .viz-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 25px;
            margin-top: 20px;
        }
        
        .viz-card {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 20px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .viz-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.12);
        }
        
        .viz-card.full-width {
            grid-column: 1 / -1;
        }
        
        .viz-title {
            font-size: 1.3rem;
            color: var(--dark);
            margin-bottom: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
        }
        
        .viz-title i {
            margin-right: 10px;
            font-size: 1.2rem;
            color: var(--secondary);
        }
        
        .chart-container {
            width: 100%;
            height: 400px;
            position: relative;
        }
        
        .chart-container-3d {
            height: 500px;
        }
        
        .chart-container-2d {
            height: 350px;
        }
        
        .tooltip {
            position: absolute;
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 12px;
            font-size: 14px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            opacity: 0;
            pointer-events: none;
            z-index: 100;
            transition: opacity 0.2s;
            max-width: 300px;
        }
        
        .tooltip h3 {
            margin-top: 0;
            color: var(--primary);
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
            margin-bottom: 8px;
        }
        
        .tooltip p {
            margin: 5px 0;
        }
        
        .tooltip .revenue {
            color: var(--success);
            font-weight: bold;
        }
        
        .legend {
            display: flex;
            justify-content: center;
            margin-top: 15px;
            flex-wrap: wrap;
            gap: 12px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            font-size: 14px;
        }
        
        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 3px;
            margin-right: 8px;
        }
        
        .loading {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10;
            font-size: 18px;
            color: var(--primary);
        }
        
        .error {
            color: var(--danger);
            text-align: center;
            padding: 20px;
            font-weight: 500;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .control-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .control-btn:hover {
            background: #2c5282;
        }
        
        .footer {
            text-align: center;
            margin-top: 40px;
            color: #718096;
            font-size: 14px;
        }
        
        @media (max-width: 768px) {
            .viz-grid {
                grid-template-columns: 1fr;
            }
            
            .chart-container-3d {
                height: 400px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>åŒºåŸŸæ–‡åŒ–äº§ä¸šæ•°æ®å¯¹æ¯”</h1>
        <p>åŸºäºå›½å®¶ç»Ÿè®¡å±€2024å¹´æ–‡åŒ–äº§ä¸šåŒºåŸŸæ•°æ®å¯è§†åŒ–åˆ†æ</p>
    </div>
    
    <div class="container">
        <div class="controls">
            <button class="control-btn" onclick="resetCharts()">é‡ç½®è§†å›¾</button>
            <button class="control-btn" onclick="toggleTheme()">åˆ‡æ¢ä¸»é¢˜</button>
        </div>
        
        <div class="section-title">
            <i class="icon">ğŸ“Š</i> ä¸‰ç»´è¡Œä¸šÃ—åŒºåŸŸè¥æ”¶åˆ†å¸ƒ
        </div>
        
        <div class="viz-card full-width">
            <div class="viz-title">
                <i class="icon">ğŸŒ</i> ä¸‰ç»´è¡Œä¸šÃ—åŒºåŸŸè¥æ”¶åˆ†å¸ƒï¼ˆäº¿å…ƒï¼‰
            </div>
            <div id="three-d-region" class="chart-container chart-container-3d">
                <div class="loading">åŠ è½½ä¸‰ç»´å¯è§†åŒ–å›¾è¡¨ä¸­...</div>
            </div>
            <div class="legend">
                <div class="legend-item"><div class="legend-color" style="background: #3182ce;"></div>ä¸œéƒ¨åœ°åŒº</div>
                <div class="legend-item"><div class="legend-color" style="background: #48bb78;"></div>ä¸­éƒ¨åœ°åŒº</div>
                <div class="legend-item"><div class="legend-color" style="background: #f6ad55;"></div>è¥¿éƒ¨åœ°åŒº</div>
                <div class="legend-item"><div class="legend-color" style="background: #fc8181;"></div>ä¸œåŒ—åœ°åŒº</div>
            </div>
        </div>
        
        <div class="section-title">
            <i class="icon">ğŸ“ˆ</i> åŒºåŸŸæ–‡åŒ–äº§ä¸šæŒ‡æ ‡å¯¹æ¯”
        </div>
        
        <div class="viz-grid">
            <div class="viz-card">
                <div class="viz-title">
                    <i class="icon">ğŸ¢</i> å››å¤§åŒºåŸŸæ€»è¥æ”¶å¯¹æ¯”ï¼ˆäº¿å…ƒï¼‰
                </div>
                <div id="region-revenue" class="chart-container chart-container-2d"></div>
            </div>
            
            <div class="viz-card">
                <div class="viz-title">
                    <i class="icon">ğŸ‘¤</i> åŒºåŸŸäººå‡æ–‡åŒ–æ¶ˆè´¹ï¼ˆå…ƒï¼‰
                </div>
                <div id="per-capita" class="chart-container chart-container-2d"></div>
            </div>
        </div>
        
        <div class="section-title">
            <i class="icon">ğŸ“‹</i> åŒºåŸŸæ•°æ®æ¦‚è§ˆ
        </div>
        
        <div class="viz-card full-width">
            <div class="viz-title">
                <i class="icon">ğŸ“Œ</i> åŒºåŸŸæ–‡åŒ–äº§ä¸šè¯¦ç»†æ•°æ®
            </div>
            <div id="data-table" style="overflow-x: auto;"></div>
        </div>
    </div>
    
    <div class="tooltip" id="tooltip"></div>
    
    <div class="footer">
        æ•°æ®æ¥æºï¼šå›½å®¶ç»Ÿè®¡å±€2024å¹´æ–‡åŒ–äº§ä¸šåŒºåŸŸæ•°æ® | å¯è§†åŒ–è®¾è®¡ Â© 2024
    </div>

    <script>
        // æ•°æ®æ¥æºï¼šå›½å®¶ç»Ÿè®¡å±€2024å¹´æ–‡åŒ–äº§ä¸šåŒºåŸŸæ•°æ®
        const regionData = [
            { 
                name: "ä¸œéƒ¨åœ°åŒº", 
                revenue: 112800, 
                growth: 7.5, 
                perCapita: 3200, 
                industries: [
                    { name: "å†…å®¹åˆ›ä½œ", revenue: 35000 },
                    { name: "åˆ›æ„è®¾è®¡", revenue: 28000 },
                    { name: "æ–‡åŒ–ä¼ æ’­", revenue: 22000 },
                    { name: "æ–‡åŒ–æŠ•èµ„", revenue: 12000 },
                    { name: "å…¶ä»–", revenue: 15800 }
                ]
            },
            { 
                name: "ä¸­éƒ¨åœ°åŒº", 
                revenue: 38600, 
                growth: 8.2, 
                perCapita: 2100, 
                industries: [
                    { name: "å†…å®¹åˆ›ä½œ", revenue: 12000 },
                    { name: "åˆ›æ„è®¾è®¡", revenue: 7500 },
                    { name: "æ–‡åŒ–ä¼ æ’­", revenue: 6800 },
                    { name: "æ–‡åŒ–æŠ•èµ„", revenue: 3500 },
                    { name: "å…¶ä»–", revenue: 8800 }
                ]
            },
            { 
                name: "è¥¿éƒ¨åœ°åŒº", 
                revenue: 28500, 
                growth: 8.8, 
                perCapita: 1900, 
                industries: [
                    { name: "å†…å®¹åˆ›ä½œ", revenue: 9500 },
                    { name: "åˆ›æ„è®¾è®¡", revenue: 5800 },
                    { name: "æ–‡åŒ–ä¼ æ’­", revenue: 5200 },
                    { name: "æ–‡åŒ–æŠ•èµ„", revenue: 2200 },
                    { name: "å…¶ä»–", revenue: 5800 }
                ]
            },
            { 
                name: "ä¸œåŒ—åœ°åŒº", 
                revenue: 8100, 
                growth: 6.5, 
                perCapita: 2300, 
                industries: [
                    { name: "å†…å®¹åˆ›ä½œ", revenue: 1500 },
                    { name: "åˆ›æ„è®¾è®¡", revenue: 1200 },
                    { name: "æ–‡åŒ–ä¼ æ’­", revenue: 1800 },
                    { name: "æ–‡åŒ–æŠ•èµ„", revenue: 800 },
                    { name: "å…¶ä»–", revenue: 2800 }
                ]
            }
        ];

        // åŒºåŸŸé¢œè‰²æ¯”ä¾‹å°º
        const regionColor = d3.scaleOrdinal()
            .domain(regionData.map(d => d.name))
            .range(["#3182ce", "#48bb78", "#f6ad55", "#fc8181"]);

        // 1. Three.jsä¸‰ç»´è¡Œä¸šÃ—åŒºåŸŸè¥æ”¶å¯¹æ¯”å›¾
        function draw3DRegionChart() {
            const container = document.getElementById("three-d-region");
            const width = container.clientWidth;
            const height = container.clientHeight;
            const loadingElement = container.querySelector('.loading');
            
            // ç§»é™¤ä¹‹å‰çš„æ¸²æŸ“å™¨
            while (container.children.length > 1) {
                container.removeChild(container.lastChild);
            }

            try {
                // åˆ›å»ºåœºæ™¯
                const scene = new THREE.Scene();
                scene.background = new THREE.Color(0xf0f4f8);

                // ç›¸æœº
                const camera = new THREE.PerspectiveCamera(60, width / height, 0.1, 1000);
                camera.position.set(40, 30, 60);

                // ä½¿ç”¨WebGLæ¸²æŸ“å™¨
                const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
                renderer.setSize(width, height);
                renderer.setClearColor(0x000000, 0);
                container.appendChild(renderer.domElement);

                // ä½¿ç”¨CSS3DRendererè¿›è¡Œæ ‡ç­¾æ¸²æŸ“
                const css3dRenderer = new THREE.CSS3DRenderer();
                css3dRenderer.setSize(width, height);
                css3dRenderer.domElement.style.position = 'absolute';
                css3dRenderer.domElement.style.top = '0';
                css3dRenderer.domElement.style.pointerEvents = 'none';
                container.appendChild(css3dRenderer.domElement);

                // æ§åˆ¶å™¨ï¼ˆå…è®¸æ—‹è½¬ã€ç¼©æ”¾ï¼‰
                const controls = new THREE.OrbitControls(camera, renderer.domElement);
                controls.enableDamping = true;
                controls.dampingFactor = 0.1;

                // å…‰æº
                const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
                scene.add(ambientLight);
                
                const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
                directionalLight.position.set(20, 40, 30);
                scene.add(directionalLight);
                
                const backLight = new THREE.DirectionalLight(0xffffff, 0.4);
                backLight.position.set(-20, -30, -20);
                scene.add(backLight);

                // æ•°æ®å‚æ•°
                const regions = regionData.map(d => d.name);
                const industries = regionData[0].industries.map(d => d.name);
                const xCount = industries.length; // Xè½´ï¼šè¡Œä¸š
                const zCount = regions.length;   // Zè½´ï¼šåŒºåŸŸ
                const gap = 4; // é—´éš”
                const baseSize = 3; // åŸºç¡€å°ºå¯¸

                // åœ°é¢ç½‘æ ¼
                const groundGeometry = new THREE.PlaneGeometry(
                    xCount * (baseSize + gap) + gap, 
                    zCount * (baseSize + gap) + gap
                );
                const groundMaterial = new THREE.MeshPhongMaterial({ 
                    color: 0xffffff, 
                    shininess: 80,
                    side: THREE.DoubleSide 
                });
                const ground = new THREE.Mesh(groundGeometry, groundMaterial);
                ground.rotation.x = -Math.PI / 2;
                ground.position.y = -0.1;
                scene.add(ground);

                // ç»˜åˆ¶ä¸‰ç»´æŸ±çŠ¶ä½“
                const cubes = [];
                const labels = [];
                
                regionData.forEach((region, zIndex) => {
                    region.industries.forEach((industry, xIndex) => {
                        // è¥æ”¶æ˜ å°„ä¸ºé«˜åº¦ï¼ˆç¼©å°1000å€ä¾¿äºæ˜¾ç¤ºï¼‰
                        const height = industry.revenue / 1000;
                        if (height <= 0) return;

                        // å‡ ä½•ä½“
                        const geometry = new THREE.BoxGeometry(baseSize, height, baseSize);
                        // æè´¨ï¼ˆåŒºåŸŸé¢œè‰²ï¼‰
                        const color = new THREE.Color(regionColor(region.name));
                        const material = new THREE.MeshPhongMaterial({ 
                            color: color,
                            shininess: 100,
                            specular: 0xffffff
                        });

                        // ä½ç½®è®¡ç®—
                        const xPos = -((xCount - 1) * (baseSize + gap)) / 2 + xIndex * (baseSize + gap);
                        const zPos = -((zCount - 1) * (baseSize + gap)) / 2 + zIndex * (baseSize + gap);
                        const yPos = height / 2; // åº•éƒ¨å¯¹é½åˆ°åœ°é¢

                        const cube = new THREE.Mesh(geometry, material);
                        cube.position.set(xPos, yPos, zPos);
                        cube.userData = {
                            region: region.name,
                            industry: industry.name,
                            revenue: industry.revenue
                        };
                        scene.add(cube);
                        cubes.push(cube);
                        
                        // åˆ›å»ºCSS3Dæ ‡ç­¾
                        const labelDiv = document.createElement('div');
                        labelDiv.className = 'data-label';
                        labelDiv.textContent = industry.name;
                        labelDiv.style.color = '#1a365d';
                        labelDiv.style.fontSize = '14px';
                        labelDiv.style.fontWeight = '600';
                        labelDiv.style.textAlign = 'center';
                        labelDiv.style.width = '100px';
                        labelDiv.style.padding = '2px 5px';
                        labelDiv.style.backgroundColor = 'rgba(255, 255, 255, 0.7)';
                        labelDiv.style.borderRadius = '3px';
                        labelDiv.style.pointerEvents = 'none';
                        
                        const label = new THREE.CSS3DSprite(labelDiv);
                        label.position.set(xPos, -3, zPos);
                        label.scale.set(0.02, 0.02, 0.02);
                        scene.add(label);
                        labels.push(label);
                    });
                });

                // åˆ›å»ºåæ ‡è½´æ ‡ç­¾
                function createAxisLabel(text, position, rotation) {
                    const labelDiv = document.createElement('div');
                    labelDiv.className = 'axis-label';
                    labelDiv.textContent = text;
                    labelDiv.style.color = '#2d3748';
                    labelDiv.style.fontSize = '16px';
                    labelDiv.style.fontWeight = 'bold';
                    labelDiv.style.pointerEvents = 'none';
                    
                    const label = new THREE.CSS3DSprite(labelDiv);
                    label.position.set(position.x, position.y, position.z);
                    if (rotation) {
                        label.rotation.set(rotation.x, rotation.y, rotation.z);
                    }
                    label.scale.set(0.03, 0.03, 0.03);
                    scene.add(label);
                    return label;
                }
                
                // Xè½´ï¼ˆè¡Œä¸šï¼‰æ ‡ç­¾
                industries.forEach((industry, i) => {
                    createAxisLabel(
                        industry,
                        {
                            x: -((xCount - 1) * (baseSize + gap)) / 2 + i * (baseSize + gap),
                            y: -1,
                            z: -((zCount * (baseSize + gap)) / 2 + gap) - 2
                        },
                        { x: Math.PI / 2, y: 0, z: 0 }
                    );
                });

                // Zè½´ï¼ˆåŒºåŸŸï¼‰æ ‡ç­¾
                regions.forEach((region, i) => {
                    createAxisLabel(
                        region,
                        {
                            x: -((xCount * (baseSize + gap)) / 2 + gap) - 2,
                            y: -1,
                            z: -((zCount - 1) * (baseSize + gap)) / 2 + i * (baseSize + gap)
                        }
                    );
                });

                // Yè½´ï¼ˆè¥æ”¶ï¼‰æ ‡ç­¾
                createAxisLabel(
                    "è¥æ”¶ï¼ˆåƒäº¿å…ƒï¼‰", 
                    { x: 0, y: 30, z: 0 }
                );

                // é¼ æ ‡äº¤äº’ï¼ˆå°„çº¿æ£€æµ‹ï¼‰
                const raycaster = new THREE.Raycaster();
                const mouse = new THREE.Vector2();
                
                function onMouseMove(event) {
                    // è®¡ç®—é¼ æ ‡åœ¨å½’ä¸€åŒ–è®¾å¤‡åæ ‡ä¸­çš„ä½ç½®
                    const rect = container.getBoundingClientRect();
                    mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
                    mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;
                }
                
                container.addEventListener("mousemove", onMouseMove);

                // åŠ¨ç”»å¾ªç¯
                function animate() {
                    requestAnimationFrame(animate);
                    
                    // æ›´æ–°å°„çº¿æ£€æµ‹
                    raycaster.setFromCamera(mouse, camera);
                    const intersects = raycaster.intersectObjects(cubes);
                    
                    if (intersects.length > 0 && intersects[0].object.userData) {
                        const data = intersects[0].object.userData;
                        const tooltip = document.getElementById("tooltip");
                        tooltip.innerHTML = `
                            <h3>${data.region} - ${data.industry}</h3>
                            <p class="revenue">è¥æ”¶ï¼š${data.revenue.toLocaleString()}äº¿å…ƒ</p>
                            <p>è¡Œä¸šå æ¯”ï¼š${((data.revenue / regionData.find(r => r.name === data.region).revenue) * 100).toFixed(1)}%</p>
                        `;
                        tooltip.style.opacity = 1;
                        tooltip.style.left = (event.clientX + 15) + "px";
                        tooltip.style.top = (event.clientY - 80) + "px";
                    } else {
                        document.getElementById("tooltip").style.opacity = 0;
                    }
                    
                    controls.update();
                    renderer.render(scene, camera);
                    css3dRenderer.render(scene, camera);
                }
                
                animate();

                // çª—å£ resize é€‚é…
                function onWindowResize() {
                    camera.aspect = container.clientWidth / container.clientHeight;
                    camera.updateProjectionMatrix();
                    renderer.setSize(container.clientWidth, container.clientHeight);
                    css3dRenderer.setSize(container.clientWidth, container.clientHeight);
                }
                
                window.addEventListener("resize", onWindowResize);
                
                // éšè—åŠ è½½æç¤º
                if (loadingElement) {
                    loadingElement.style.display = 'none';
                }
                
            } catch (error) {
                console.error("3Dæ¸²æŸ“é”™è¯¯:", error);
                if (loadingElement) {
                    loadingElement.innerHTML = `<div class="error">æ— æ³•åŠ è½½3Då›¾è¡¨ï¼š${error.message}</div>`;
                }
            }
        }

        // 2. åŒºåŸŸè¥æ”¶æŸ±çŠ¶å›¾
        function drawRegionRevenue() {
            const container = document.getElementById("region-revenue");
            container.innerHTML = '';
            const width = container.clientWidth;
            const height = container.clientHeight;
            const margin = { top: 30, right: 30, bottom: 60, left: 60 };
            const innerWidth = width - margin.left - margin.right;
            const innerHeight = height - margin.top - margin.bottom;

            const svg = d3.select("#region-revenue")
                .append("svg")
                .attr("width", width)
                .attr("height", height)
                .append("g")
                .attr("transform", `translate(${margin.left}, ${margin.top})`);

            // æ¯”ä¾‹å°º
            const x = d3.scaleBand()
                .domain(regionData.map(d => d.name))
                .range([0, innerWidth])
                .padding(0.3);
                
            const y = d3.scaleLinear()
                .domain([0, d3.max(regionData, d => d.revenue) * 1.1])
                .range([innerHeight, 0]);

            // åæ ‡è½´
            svg.append("g")
                .attr("transform", `translate(0, ${innerHeight})`)
                .call(d3.axisBottom(x))
                .selectAll("text")
                .attr("transform", "rotate(-15)")
                .attr("text-anchor", "end")
                .attr("dy", "0.5em");
                
            svg.append("g")
                .call(d3.axisLeft(y).ticks(6).tickFormat(d => (d/10000).toFixed(1) + "ä¸‡äº¿"))
                .append("text")
                .attr("fill", "#333")
                .attr("transform", "rotate(-90)")
                .attr("y", -50)
                .attr("x", -innerHeight / 2)
                .attr("text-anchor", "middle")
                .text("æ€»è¥æ”¶ï¼ˆäº¿å…ƒï¼‰");

            // æŸ±çŠ¶å›¾
            const bars = svg.selectAll(".region-bar")
                .data(regionData)
                .enter()
                .append("rect")
                .attr("class", "region-bar")
                .attr("x", d => x(d.name))
                .attr("y", d => y(d.revenue))
                .attr("width", x.bandwidth())
                .attr("height", d => innerHeight - y(d.revenue))
                .attr("fill", d => regionColor(d.name))
                .attr("rx", 4)
                .attr("ry", 4)
                .on("mouseover", (e, d) => {
                    d3.select("#tooltip")
                        .html(`<h3>${d.name}</h3>
                               <p class="revenue">æ€»è¥æ”¶ï¼š${d.revenue.toLocaleString()}äº¿å…ƒ</p>
                               <p>å¢é•¿ç‡ï¼š${d.growth}%</p>
                               <p>å å…¨å›½æ¯”ä¾‹ï¼š${((d.revenue / regionData.reduce((sum, r) => sum + r.revenue, 0)) * 100).toFixed(1)}%</p>`)
                        .style("opacity", 1)
                        .style("left", (e.pageX + 10) + "px")
                        .style("top", (e.pageY - 20) + "px");
                })
                .on("mouseout", () => d3.select("#tooltip").style("opacity", 0));

            // é¡¶éƒ¨æ ‡ç­¾ï¼ˆè¥æ”¶å€¼ï¼‰
            svg.selectAll(".revenue-label")
                .data(regionData)
                .enter()
                .append("text")
                .attr("class", "revenue-label")
                .attr("x", d => x(d.name) + x.bandwidth() / 2)
                .attr("y", d => y(d.revenue) - 10)
                .attr("text-anchor", "middle")
                .style("font-size", "12px")
                .style("font-weight", "600")
                .style("fill", "#1a365d")
                .text(d => (d.revenue / 10000).toFixed(1) + "ä¸‡äº¿");
        }

        // 3. åŒºåŸŸäººå‡æ–‡åŒ–æ¶ˆè´¹å¯¹æ¯”
        function drawPerCapita() {
            const container = document.getElementById("per-capita");
            container.innerHTML = '';
            const width = container.clientWidth;
            const height = container.clientHeight;
            const margin = { top: 30, right: 30, bottom: 60, left: 60 };
            const innerWidth = width - margin.left - margin.right;
            const innerHeight = height - margin.top - margin.bottom;

            const svg = d3.select("#per-capita")
                .append("svg")
                .attr("width", width)
                .attr("height", height)
                .append("g")
                .attr("transform", `translate(${margin.left}, ${margin.top})`);

            // æ’åºï¼ˆä»é«˜åˆ°ä½ï¼‰
            const sortedData = [...regionData].sort((a, b) => b.perCapita - a.perCapita);

            // æ¯”ä¾‹å°º
            const x = d3.scaleBand()
                .domain(sortedData.map(d => d.name))
                .range([0, innerWidth])
                .padding(0.3);
                
            const y = d3.scaleLinear()
                .domain([0, d3.max(sortedData, d => d.perCapita) * 1.1])
                .range([innerHeight, 0]);

            // åæ ‡è½´
            svg.append("g")
                .attr("transform", `translate(0, ${innerHeight})`)
                .call(d3.axisBottom(x))
                .selectAll("text")
                .attr("transform", "rotate(-15)")
                .attr("text-anchor", "end")
                .attr("dy", "0.5em");
                
            svg.append("g")
                .call(d3.axisLeft(y))
                .append("text")
                .attr("fill", "#333")
                .attr("transform", "rotate(-90)")
                .attr("y", -50)
                .attr("x", -innerHeight / 2)
                .attr("text-anchor", "middle")
                .text("äººå‡æ–‡åŒ–æ¶ˆè´¹ï¼ˆå…ƒï¼‰");

            // æŸ±çŠ¶å›¾
            svg.selectAll(".per-capita-bar")
                .data(sortedData)
                .enter()
                .append("rect")
                .attr("class", "per-capita-bar")
                .attr("x", d => x(d.name))
                .attr("y", d => y(d.perCapita))
                .attr("width", x.bandwidth())
                .attr("height", d => innerHeight - y(d.perCapita))
                .attr("fill", d => regionColor(d.name))
                .attr("rx", 4)
                .attr("ry", 4)
                .on("mouseover", (e, d) => {
                    d3.select("#tooltip")
                        .html(`<h3>${d.name}</h3>
                               <p>äººå‡æ–‡åŒ–æ¶ˆè´¹ï¼š<span class="revenue">${d.perCapita}å…ƒ</span></p>
                               <p>å…¨å›½å¹³å‡ï¼š${(regionData.reduce((sum, r) => sum + r.perCapita, 0) / regionData.length).toFixed(0)}å…ƒ</p>`)
                        .style("opacity", 1)
                        .style("left", (e.pageX + 10) + "px")
                        .style("top", (e.pageY - 20) + "px");
                })
                .on("mouseout", () => d3.select("#tooltip").style("opacity", 0));
                
            // æ·»åŠ æ•°å€¼æ ‡ç­¾
            svg.selectAll(".per-capita-label")
                .data(sortedData)
                .enter()
                .append("text")
                .attr("class", "per-capita-label")
                .attr("x", d => x(d.name) + x.bandwidth() / 2)
                .attr("y", d => y(d.perCapita) - 8)
                .attr("text-anchor", "middle")
                .style("font-size", "12px")
                .style("font-weight", "600")
                .style("fill", "#1a365d")
                .text(d => d.perCapita + "å…ƒ");
        }
        
        // 4. åˆ›å»ºæ•°æ®è¡¨æ ¼
        function createDataTable() {
            const container = document.getElementById("data-table");
            const table = document.createElement('table');
            table.style.width = '100%';
            table.style.borderCollapse = 'collapse';
            table.style.marginTop = '15px';
            
            // è¡¨å¤´
            const thead = table.createTHead();
            const headerRow = thead.insertRow();
            const headers = ['åŒºåŸŸ', 'æ€»è¥æ”¶(äº¿å…ƒ)', 'å¢é•¿ç‡(%)', 'äººå‡æ¶ˆè´¹(å…ƒ)', 'å†…å®¹åˆ›ä½œ', 'åˆ›æ„è®¾è®¡', 'æ–‡åŒ–ä¼ æ’­', 'æ–‡åŒ–æŠ•èµ„', 'å…¶ä»–'];
            
            headers.forEach(headerText => {
                const th = document.createElement('th');
                th.textContent = headerText;
                th.style.padding = '12px 15px';
                th.style.textAlign = 'left';
                th.style.backgroundColor = '#f0f4f8';
                th.style.borderBottom = '1px solid #cbd5e0';
                headerRow.appendChild(th);
            });
            
            // è¡¨æ ¼å†…å®¹
            const tbody = document.createElement('tbody');
            table.appendChild(tbody);
            
            regionData.forEach(region => {
                const row = tbody.insertRow();
                row.style.borderBottom = '1px solid #e2e8f0';
                
                // åŒºåŸŸåç§°
                const regionCell = row.insertCell();
                regionCell.textContent = region.name;
                regionCell.style.padding = '12px 15px';
                regionCell.style.fontWeight = '600';
                regionCell.style.color = regionColor(region.name);
                
                // æ€»è¥æ”¶
                const revenueCell = row.insertCell();
                revenueCell.textContent = region.revenue.toLocaleString();
                revenueCell.style.padding = '12px 15px';
                
                // å¢é•¿ç‡
                const growthCell = row.insertCell();
                growthCell.textContent = region.growth;
                growthCell.style.padding = '12px 15px';
                growthCell.style.color = region.growth > 7.5 ? '#48bb78' : '#fc8181';
                growthCell.style.fontWeight = '600';
                
                // äººå‡æ¶ˆè´¹
                const perCapitaCell = row.insertCell();
                perCapitaCell.textContent = region.perCapita;
                perCapitaCell.style.padding = '12px 15px';
                
                // å„è¡Œä¸šæ•°æ®
                region.industries.forEach(industry => {
                    const industryCell = row.insertCell();
                    industryCell.textContent = industry.revenue.toLocaleString();
                    industryCell.style.padding = '12px 15px';
                });
            });
            
            container.appendChild(table);
        }
        
        // é‡ç½®æ‰€æœ‰å›¾è¡¨è§†å›¾
        function resetCharts() {
            draw3DRegionChart();
            drawRegionRevenue();
            drawPerCapita();
        }
        
        // åˆ‡æ¢ä¸»é¢˜
        function toggleTheme() {
            document.body.classList.toggle('dark-theme');
        }

        // åˆå§‹åŒ–å›¾è¡¨
        window.onload = function() {
            draw3DRegionChart();
            drawRegionRevenue();
            drawPerCapita();
            createDataTable();
        }
    </script>
</body>
</html>
