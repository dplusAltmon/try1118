<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>区域文化产业数据三维可视化</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.124.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.124.0/examples/js/controls/OrbitControls.js"></script>
    <style>
        :root {
            --primary: #1a365d;
            --secondary: #3182ce;
            --success: #48bb78;
            --warning: #f6ad55;
            --danger: #fc8181;
            --light: #f7fafc;
            --dark: #2d3748;
            --gray: #e2e8f0;
            --border-radius: 8px;
            --shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f0f4f8 0%, #e6f7ff 100%);
            color: #333;
            line-height: 1.6;
            padding-bottom: 40px;
        }
        
        .header {
            background: linear-gradient(to right, var(--primary), #2c5282);
            color: white;
            padding: 2rem 0;
            text-align: center;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }
        
        .header p {
            font-size: 1.1rem;
            max-width: 800px;
            margin: 0 auto;
            opacity: 0.9;
        }
        
        .container {
            width: 90%;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .section-title {
            color: var(--primary);
            font-size: 1.8rem;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--gray);
            margin-bottom: 1.5rem;
            position: relative;
            display: flex;
            align-items: center;
        }
        
        .section-title::after {
            content: "";
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 120px;
            height: 3px;
            background: var(--secondary);
        }
        
        .viz-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 25px;
            margin-top: 20px;
        }
        
        .viz-card {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 20px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .viz-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.12);
        }
        
        .viz-card.full-width {
            grid-column: 1 / -1;
        }
        
        .viz-title {
            font-size: 1.3rem;
            color: var(--dark);
            margin-bottom: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
        }
        
        .viz-title i {
            margin-right: 10px;
            font-size: 1.2rem;
            color: var(--secondary);
        }
        
        .chart-container {
            width: 100%;
            height: 500px;
            position: relative;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            background: white;
        }
        
        .tooltip {
            position: absolute;
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 12px;
            font-size: 14px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            opacity: 0;
            pointer-events: none;
            z-index: 100;
            transition: opacity 0.2s;
            max-width: 300px;
        }
        
        .tooltip h3 {
            margin-top: 0;
            color: var(--primary);
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
            margin-bottom: 8px;
        }
        
        .tooltip p {
            margin: 5px 0;
        }
        
        .tooltip .revenue {
            color: var(--success);
            font-weight: bold;
        }
        
        .legend {
            display: flex;
            justify-content: center;
            margin-top: 15px;
            flex-wrap: wrap;
            gap: 12px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            font-size: 14px;
            background: rgba(255,255,255,0.8);
            padding: 4px 8px;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 3px;
            margin-right: 8px;
        }
        
        .loading {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10;
            font-size: 18px;
            color: var(--primary);
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .control-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s;
            font-weight: 600;
        }
        
        .control-btn:hover {
            background: #2c5282;
            transform: translateY(-2px);
        }
        
        .footer {
            text-align: center;
            margin-top: 40px;
            color: #718096;
            font-size: 14px;
            padding: 20px 0;
            border-top: 1px solid #e2e8f0;
        }
        
        @media (max-width: 768px) {
            .viz-grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .chart-container {
                height: 400px;
            }
        }
        
        .info-panel {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            padding: 15px;
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 50;
            max-width: 300px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .info-panel h3 {
            color: var(--primary);
            margin-bottom: 10px;
            font-size: 1.2rem;
        }
        
        .info-panel p {
            margin-bottom: 8px;
            font-size: 0.9rem;
            line-height: 1.4;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>区域文化产业数据三维可视化</h1>
        <p>基于国家统计局2024年文化产业区域数据深度分析</p>
    </div>
    
    <div class="container">
        <div class="controls">
            <button class="control-btn" onclick="resetView()">重置视图</button>
            <button class="control-btn" onclick="toggleGrid()">切换网格</button>
            <button class="control-btn" onclick="toggleRotation()">旋转控制</button>
        </div>
        
        <div class="section-title">
            <i class="icon">🌐</i> 三维行业区域营收分布（亿元）
        </div>
        
        <div class="viz-card full-width">
            <div class="info-panel">
                <h3>数据解读指南</h3>
                <p><span style="display:inline-block; width:12px; height:12px; background:#3182ce; border-radius:2px; margin-right:5px;"></span> X轴：区域分布</p>
                <p><span style="display:inline-block; width:12px; height:12px; background:#48bb78; border-radius:2px; margin-right:5px;"></span> Y轴：行业类别</p>
                <p><span style="display:inline-block; width:12px; height:12px; background:#f6ad55; border-radius:2px; margin-right:5px;"></span> Z轴：营收金额</p>
                <p>柱状高度代表营收金额，可旋转视图多角度观察</p>
            </div>
            
            <div id="three-d-chart" class="chart-container">
                <div class="loading">加载三维可视化图表中...</div>
            </div>
            
            <div class="legend">
                <div class="legend-item"><div class="legend-color" style="background: #3182ce;"></div>东部地区</div>
                <div class="legend-item"><div class="legend-color" style="background: #48bb78;"></div>中部地区</div>
                <div class="legend-item"><div class="legend-color" style="background: #f6ad55;"></div>西部地区</div>
                <div class="legend-item"><div class="legend-color" style="background: #fc8181;"></div>东北地区</div>
            </div>
        </div>
        
        <div class="section-title">
            <i class="icon">📊</i> 区域文化产业数据概览
        </div>
        
        <div class="viz-grid">
            <div class="viz-card">
                <div class="viz-title">
                    <i class="icon">🏢</i> 区域总营收对比（亿元）
                </div>
                <div id="revenue-chart" class="chart-container" style="height: 350px;"></div>
            </div>
            
            <div class="viz-card">
                <div class="viz-title">
                    <i class="icon">📈</i> 区域人均文化消费（元）
                </div>
                <div id="per-capita-chart" class="chart-container" style="height: 350px;"></div>
            </div>
        </div>
    </div>
    
    <div class="tooltip" id="tooltip"></div>
    
    <div class="footer">
        数据来源：国家统计局2024年文化产业区域数据 | 可视化设计 © 2024
    </div>

    <script>
        // 数据来源：国家统计局2024年文化产业区域数据
        const regionData = [
            { 
                name: "东部地区", 
                revenue: 112800, 
                growth: 7.5, 
                perCapita: 3200, 
                industries: [
                    { name: "内容创作", revenue: 35000 },
                    { name: "创意设计", revenue: 28000 },
                    { name: "文化传播", revenue: 22000 },
                    { name: "文化投资", revenue: 12000 },
                    { name: "其他", revenue: 15800 }
                ]
            },
            { 
                name: "中部地区", 
                revenue: 38600, 
                growth: 8.2, 
                perCapita: 2100, 
                industries: [
                    { name: "内容创作", revenue: 12000 },
                    { name: "创意设计", revenue: 7500 },
                    { name: "文化传播", revenue: 6800 },
                    { name: "文化投资", revenue: 3500 },
                    { name: "其他", revenue: 8800 }
                ]
            },
            { 
                name: "西部地区", 
                revenue: 28500, 
                growth: 8.8, 
                perCapita: 1900, 
                industries: [
                    { name: "内容创作", revenue: 9500 },
                    { name: "创意设计", revenue: 5800 },
                    { name: "文化传播", revenue: 5200 },
                    { name: "文化投资", revenue: 2200 },
                    { name: "其他", revenue: 5800 }
                ]
            },
            { 
                name: "东北地区", 
                revenue: 8100, 
                growth: 6.5, 
                perCapita: 2300, 
                industries: [
                    { name: "内容创作", revenue: 1500 },
                    { name: "创意设计", revenue: 1200 },
                    { name: "文化传播", revenue: 1800 },
                    { name: "文化投资", revenue: 800 },
                    { name: "其他", revenue: 2800 }
                ]
            }
        ];

        // 区域颜色比例尺
        const regionColor = d3.scaleOrdinal()
            .domain(regionData.map(d => d.name))
            .range(["#3182ce", "#48bb78", "#f6ad55", "#fc8181"]);

        // 行业列表
        const industries = regionData[0].industries.map(d => d.name);
        
        // 三维图表变量
        let scene, camera, renderer, controls;
        let rotationEnabled = true;
        let gridVisible = true;
        
        // 1. Three.js三维行业×区域营收对比图
        function init3DChart() {
            const container = document.getElementById("three-d-chart");
            const width = container.clientWidth;
            const height = container.clientHeight;
            const loadingElement = container.querySelector('.loading');
            
            // 清除容器内容
            while (container.children.length > 1) {
                container.removeChild(container.lastChild);
            }

            try {
                // 创建场景
                scene = new THREE.Scene();
                scene.background = new THREE.Color(0xf0f4f8);
                scene.fog = new THREE.Fog(0xf0f4f8, 20, 100);

                // 相机
                camera = new THREE.PerspectiveCamera(60, width / height, 0.1, 1000);
                camera.position.set(25, 20, 30);

                // 使用WebGL渲染器
                renderer = new THREE.WebGLRenderer({ 
                    antialias: true,
                    alpha: true
                });
                renderer.setSize(width, height);
                renderer.setClearColor(0x000000, 0);
                renderer.shadowMap.enabled = true;
                container.appendChild(renderer.domElement);

                // 控制器（允许旋转、缩放）
                controls = new THREE.OrbitControls(camera, renderer.domElement);
                controls.enableDamping = true;
                controls.dampingFactor = 0.05;
                controls.rotateSpeed = 0.5;
                controls.autoRotate = rotationEnabled;
                controls.autoRotateSpeed = 1.0;

                // 光源
                const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
                scene.add(ambientLight);
                
                const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
                directionalLight.position.set(20, 40, 30);
                directionalLight.castShadow = true;
                scene.add(directionalLight);
                
                const backLight = new THREE.DirectionalLight(0xffffff, 0.4);
                backLight.position.set(-20, -30, -20);
                scene.add(backLight);

                // 坐标轴辅助
                const axesHelper = new THREE.AxesHelper(15);
                scene.add(axesHelper);

                // 网格辅助
                const gridHelper = new THREE.GridHelper(30, 10, 0xcccccc, 0xcccccc);
                gridHelper.visible = gridVisible;
                scene.add(gridHelper);

                // 数据参数
                const regions = regionData.map(d => d.name);
                const xCount = regions.length; // X轴：区域
                const zCount = industries.length; // Z轴：行业
                const gap = 2; // 间隔
                const baseSize = 1.5; // 基础尺寸

                // 绘制三维柱状体
                regionData.forEach((region, regionIndex) => {
                    region.industries.forEach((industry, industryIndex) => {
                        // 营收映射为高度（缩小1000倍便于显示）
                        const height = industry.revenue / 3000;
                        if (height <= 0) return;

                        // 几何体
                        const geometry = new THREE.CylinderGeometry(0.7, 0.7, height, 16);
                        geometry.translate(0, height/2, 0);
                        
                        // 材质（区域颜色）
                        const color = new THREE.Color(regionColor(region.name));
                        const material = new THREE.MeshPhongMaterial({ 
                            color: color,
                            shininess: 100,
                            specular: 0xffffff
                        });

                        // 位置计算
                        const xPos = regionIndex * (baseSize + gap) - ((xCount-1) * (baseSize + gap))/2;
                        const zPos = industryIndex * (baseSize + gap) - ((zCount-1) * (baseSize + gap))/2;
                        const yPos = height / 2; // 底部对齐到地面

                        const cylinder = new THREE.Mesh(geometry, material);
                        cylinder.position.set(xPos, yPos, zPos);
                        cylinder.castShadow = true;
                        cylinder.receiveShadow = true;
                        cylinder.userData = {
                            region: region.name,
                            industry: industry.name,
                            revenue: industry.revenue
                        };
                        scene.add(cylinder);
                    });
                });

                // 添加坐标轴标签
                addAxisLabels(regions, industries, baseSize, gap);

                // 动画循环
                function animate() {
                    requestAnimationFrame(animate);
                    controls.update();
                    renderer.render(scene, camera);
                }
                
                animate();

                // 窗口 resize 适配
                function onWindowResize() {
                    camera.aspect = container.clientWidth / container.clientHeight;
                    camera.updateProjectionMatrix();
                    renderer.setSize(container.clientWidth, container.clientHeight);
                }
                
                window.addEventListener("resize", onWindowResize);
                
                // 鼠标交互（射线检测）
                const raycaster = new THREE.Raycaster();
                const mouse = new THREE.Vector2();
                
                function onMouseMove(event) {
                    // 计算鼠标在归一化设备坐标中的位置
                    const rect = container.getBoundingClientRect();
                    mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
                    mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;
                    
                    // 更新射线检测
                    raycaster.setFromCamera(mouse, camera);
                    const intersects = raycaster.intersectObjects(scene.children);
                    
                    if (intersects.length > 0 && intersects[0].object.userData) {
                        const data = intersects[0].object.userData;
                        const tooltip = document.getElementById("tooltip");
                        tooltip.innerHTML = `
                            <h3>${data.region} - ${data.industry}</h3>
                            <p class="revenue">营收：${data.revenue.toLocaleString()}亿元</p>
                            <p>占比：${((data.revenue / regionData.find(r => r.name === data.region).revenue) * 100).toFixed(1)}%</p>
                        `;
                        tooltip.style.opacity = 1;
                        tooltip.style.left = (event.clientX + 15) + "px";
                        tooltip.style.top = (event.clientY - 80) + "px";
                    } else {
                        document.getElementById("tooltip").style.opacity = 0;
                    }
                }
                
                container.addEventListener("mousemove", onMouseMove);
                
                // 隐藏加载提示
                if (loadingElement) {
                    loadingElement.style.display = 'none';
                }
                
            } catch (error) {
                console.error("3D渲染错误:", error);
                if (loadingElement) {
                    loadingElement.innerHTML = `<div class="error">无法加载3D图表：${error.message}</div>`;
                }
            }
        }

        // 添加坐标轴标签
        function addAxisLabels(regions, industries, baseSize, gap) {
            // X轴标签（区域）
            regions.forEach((region, i) => {
                const xPos = i * (baseSize + gap) - ((regions.length-1) * (baseSize + gap))/2;
                const textGeometry = createTextGeometry(region, 1.5);
                const textMaterial = new THREE.MeshBasicMaterial({ color: 0x1a365d });
                const textMesh = new THREE.Mesh(textGeometry, textMaterial);
                textMesh.position.set(xPos, -1, -((industries.length) * (baseSize + gap))/2 - 1);
                textMesh.rotation.x = -Math.PI / 2;
                scene.add(textMesh);
            });
            
            // Z轴标签（行业）
            industries.forEach((industry, i) => {
                const zPos = i * (baseSize + gap) - ((industries.length-1) * (baseSize + gap))/2;
                const textGeometry = createTextGeometry(industry, 1.5);
                const textMaterial = new THREE.MeshBasicMaterial({ color: 0x1a365d });
                const textMesh = new THREE.Mesh(textGeometry, textMaterial);
                textMesh.position.set(-((regions.length) * (baseSize + gap))/2 - 1, -1, zPos);
                textMesh.rotation.x = -Math.PI / 2;
                scene.add(textMesh);
            });
            
            // Y轴标签（营收）
            const textGeometry = createTextGeometry("营收 (亿元)", 2);
            const textMaterial = new THREE.MeshBasicMaterial({ color: 0x1a365d });
            const textMesh = new THREE.Mesh(textGeometry, textMaterial);
            textMesh.position.set(0, 15, -((industries.length) * (baseSize + gap))/2 - 3);
            textMesh.rotation.x = -Math.PI / 2;
            scene.add(textMesh);
        }
        
        // 创建文本几何体
        function createTextGeometry(text, size) {
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.width = 512;
            canvas.height = 256;
            context.fillStyle = '#1a365d';
            context.font = 'Bold 80px Arial';
            context.textAlign = 'center';
            context.textBaseline = 'middle';
            context.fillText(text, canvas.width/2, canvas.height/2);
            
            const texture = new THREE.CanvasTexture(canvas);
            const material = new THREE.MeshBasicMaterial({
                map: texture,
                transparent: true,
                side: THREE.DoubleSide
            });
            
            // 根据文本长度调整几何体尺寸
            const textWidth = context.measureText(text).width;
            const geometry = new THREE.PlaneGeometry(textWidth * size / 100, size * 1.5);
            return geometry;
        }

        // 2. 区域营收柱状图
        function drawRevenueChart() {
            const container = document.getElementById("revenue-chart");
            container.innerHTML = '';
            const width = container.clientWidth;
            const height = container.clientHeight;
            const margin = { top: 30, right: 30, bottom: 60, left: 60 };
            const innerWidth = width - margin.left - margin.right;
            const innerHeight = height - margin.top - margin.bottom;

            const svg = d3.select("#revenue-chart")
                .append("svg")
                .attr("width", width)
                .attr("height", height)
                .append("g")
                .attr("transform", `translate(${margin.left}, ${margin.top})`);

            // 比例尺
            const x = d3.scaleBand()
                .domain(regionData.map(d => d.name))
                .range([0, innerWidth])
                .padding(0.3);
                
            const y = d3.scaleLinear()
                .domain([0, d3.max(regionData, d => d.revenue) * 1.1])
                .range([innerHeight, 0]);

            // 坐标轴
            svg.append("g")
                .attr("transform", `translate(0, ${innerHeight})`)
                .call(d3.axisBottom(x))
                .selectAll("text")
                .attr("transform", "rotate(-15)")
                .attr("text-anchor", "end")
                .attr("dy", "0.5em");
                
            svg.append("g")
                .call(d3.axisLeft(y).ticks(6).tickFormat(d => (d/10000).toFixed(1) + "万亿"))
                .append("text")
                .attr("fill", "#333")
                .attr("transform", "rotate(-90)")
                .attr("y", -50)
                .attr("x", -innerHeight / 2)
                .attr("text-anchor", "middle")
                .text("总营收（亿元）");

            // 柱状图
            const bars = svg.selectAll(".region-bar")
                .data(regionData)
                .enter()
                .append("rect")
                .attr("class", "region-bar")
                .attr("x", d => x(d.name))
                .attr("y", d => y(d.revenue))
                .attr("width", x.bandwidth())
                .attr("height", d => innerHeight - y(d.revenue))
                .attr("fill", d => regionColor(d.name))
                .attr("rx", 4)
                .attr("ry", 4)
                .on("mouseover", (e, d) => {
                    d3.select("#tooltip")
                        .html(`<h3>${d.name}</h3>
                               <p class="revenue">总营收：${d.revenue.toLocaleString()}亿元</p>
                               <p>增长率：${d.growth}%</p>
                               <p>占全国比例：${((d.revenue / regionData.reduce((sum, r) => sum + r.revenue, 0)) * 100).toFixed(1)}%</p>`)
                        .style("opacity", 1)
                        .style("left", (e.pageX + 10) + "px")
                        .style("top", (e.pageY - 20) + "px");
                })
                .on("mouseout", () => d3.select("#tooltip").style("opacity", 0));

            // 顶部标签（营收值）
            svg.selectAll(".revenue-label")
                .data(regionData)
                .enter()
                .append("text")
                .attr("class", "revenue-label")
                .attr("x", d => x(d.name) + x.bandwidth() / 2)
                .attr("y", d => y(d.revenue) - 10)
                .attr("text-anchor", "middle")
                .style("font-size", "12px")
                .style("font-weight", "600")
                .style("fill", "#1a365d")
                .text(d => (d.revenue / 10000).toFixed(1) + "万亿");
        }

        // 3. 区域人均文化消费对比
        function drawPerCapitaChart() {
            const container = document.getElementById("per-capita-chart");
            container.innerHTML = '';
            const width = container.clientWidth;
            const height = container.clientHeight;
            const margin = { top: 30, right: 30, bottom: 60, left: 60 };
            const innerWidth = width - margin.left - margin.right;
            const innerHeight = height - margin.top - margin.bottom;

            const svg = d3.select("#per-capita-chart")
                .append("svg")
                .attr("width", width)
                .attr("height", height)
                .append("g")
                .attr("transform", `translate(${margin.left}, ${margin.top})`);

            // 排序（从高到低）
            const sortedData = [...regionData].sort((a, b) => b.perCapita - a.perCapita);

            // 比例尺
            const x = d3.scaleBand()
                .domain(sortedData.map(d => d.name))
                .range([0, innerWidth])
                .padding(0.3);
                
            const y = d3.scaleLinear()
                .domain([0, d3.max(sortedData, d => d.perCapita) * 1.1])
                .range([innerHeight, 0]);

            // 坐标轴
            svg.append("g")
                .attr("transform", `translate(0, ${innerHeight})`)
                .call(d3.axisBottom(x))
                .selectAll("text")
                .attr("transform", "rotate(-15)")
                .attr("text-anchor", "end")
                .attr("dy", "0.5em");
                
            svg.append("g")
                .call(d3.axisLeft(y))
                .append("text")
                .attr("fill", "#333")
                .attr("transform", "rotate(-90)")
                .attr("y", -50)
                .attr("x", -innerHeight / 2)
                .attr("text-anchor", "middle")
                .text("人均文化消费（元）");

            // 柱状图
            svg.selectAll(".per-capita-bar")
                .data(sortedData)
                .enter()
                .append("rect")
                .attr("class", "per-capita-bar")
                .attr("x", d => x(d.name))
                .attr("y", d => y(d.perCapita))
                .attr("width", x.bandwidth())
                .attr("height", d => innerHeight - y(d.perCapita))
                .attr("fill", d => regionColor(d.name))
                .attr("rx", 4)
                .attr("ry", 4)
                .on("mouseover", (e, d) => {
                    d3.select("#tooltip")
                        .html(`<h3>${d.name}</h3>
                               <p>人均文化消费：<span class="revenue">${d.perCapita}元</span></p>
                               <p>全国平均：${(regionData.reduce((sum, r) => sum + r.perCapita, 0) / regionData.length).toFixed(0)}元</p>`)
                        .style("opacity", 1)
                        .style("left", (e.pageX + 10) + "px")
                        .style("top", (e.pageY - 20) + "px");
                })
                .on("mouseout", () => d3.select("#tooltip").style("opacity", 0));
                
            // 添加数值标签
            svg.selectAll(".per-capita-label")
                .data(sortedData)
                .enter()
                .append("text")
                .attr("class", "per-capita-label")
                .attr("x", d => x(d.name) + x.bandwidth() / 2)
                .attr("y", d => y(d.perCapita) - 8)
                .attr("text-anchor", "middle")
                .style("font-size", "12px")
                .style("font-weight", "600")
                .style("fill", "#1a365d")
                .text(d => d.perCapita + "元");
        }
        
        // 控制函数
        function resetView() {
            if (camera && controls) {
                camera.position.set(25, 20, 30);
                controls.reset();
            }
        }
        
        function toggleGrid() {
            gridVisible = !gridVisible;
            const gridHelper = scene.children.find(obj => obj instanceof THREE.GridHelper);
            if (gridHelper) {
                gridHelper.visible = gridVisible;
            }
        }
        
        function toggleRotation() {
            rotationEnabled = !rotationEnabled;
            if (controls) {
                controls.autoRotate = rotationEnabled;
            }
        }

        // 初始化图表
        window.onload = function() {
            init3DChart();
            drawRevenueChart();
            drawPerCapitaChart();
        }
    </script>
</body>
</html>
